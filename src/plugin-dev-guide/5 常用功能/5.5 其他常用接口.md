---
title: å…¶ä»–å¸¸ç”¨æ¥å£
date: 2023-08-26 10:06:59
updated: 2023-07-20 16:51:54
---
5.5 å…¶ä»–å¸¸ç”¨æ¥å£

ğŸ’¡

å…³äºæ¥å£å®šä¹‰ï¼Œè¯·å‚è§æ¥å£å®šä¹‰åŒ…ï¼šhttps://github.com/windingwind/zotero-types

å¦‚æœä½¿ç”¨æ’ä»¶æ¨¡æ¿ï¼Œè¯¥NPMåŒ…å·²ç»å†…ç½®äº†ï¼›è¦åœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œè¯·`npm install --save-dev zotero-types`å¹¶å°†å…¶åŠ å…¥includesè·¯å¾„ã€‚

# ZoteroPane

ZoteroPaneæ˜¯Zoteroä¸­ä¸»ç•Œé¢é¡¹ç›®è§†å›¾çš„æŠ½è±¡ã€‚å¯ç”¨äºè·å–é€‰ä¸­çš„é¡¹ç›®ï¼Œç­‰ç­‰ã€‚

æºç ä½ç½®ï¼š[chrome/content/zotero/zoteroPane.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/zoteroPane.js)

å¯é€šè¿‡ZoteroPane.getSelectedItems()è·å–é€‰ä¸­çš„æ¡ç›®ï¼›

é€šè¿‡ZoteroPane.itemsView.onSelect.addListeneræ·»åŠ æ¡ç›®é€‰ä¸­äº‹ä»¶ç›‘å¬ã€‚

```
ZoteroPane.selectItem(itemID);  // å¿…é¡»å…ˆåˆ‡æ¢åˆ°æ–‡åº“æ ‡ç­¾é¡µ
```

# Zotero.Collectionsä¸Zotero.Collection

Collectionï¼ˆé›†åˆï¼‰æ˜¯Zoteroä¸­æ‰€æœ‰æ¡ç›®çš„çˆ¶å±‚çº§ï¼Œæ˜¯Libraryï¼ˆåº“ï¼‰çš„å­å±‚çº§ã€‚

[chrome\\content\\zotero\\xpcom\\data\\collection.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/data/collection.js) å®šä¹‰äº†Zotero.Collectionç±»

[chrome\\content\\zotero\\xpcom\\data\\collections.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/data/collections.js) å®šä¹‰äº†Zotero.Collectionså¯¹è±¡ï¼Œç”¨äºè®¿é—®ç›¸å…³æ–¹æ³•

# Zotero.Librariesä¸Zotero.Library

Librayï¼ˆåº“ï¼‰æ˜¯Zoteroä¸­æ‰€æœ‰æ¡ç›®æœ€ç»ˆçš„çˆ¶å±‚çº§ã€‚Zoteroåº“åˆ†ä¸ºç”¨æˆ·åº“ï¼ˆid=1ï¼‰ä¸ç¾¤ç»„åº“ï¼Œåº“ä¹‹é—´çš„å†…å®¹å­˜å‚¨æ–¹å¼å¯èƒ½å…·æœ‰è¾ƒå¤§ä¸åŒã€‚

[chrome\\content\\zotero\\xpcom\\data\\library.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/data/library.js) å®šä¹‰äº†Zotero.Libraryç±»

[chrome\\content\\zotero\\xpcom\\data\\librarys.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/data/libraries.js) å®šä¹‰äº†Zotero.Librariesæ–¹æ³•ï¼Œç”¨äºè®¿é—®ç›¸å…³æ–¹æ³•

# Zotero.Reader

Zotero.Readeræ˜¯PDFé˜…è¯»å™¨çš„æ¥å£ï¼Œä½†å¯¹äºé˜…è¯»å™¨ä¸­è¯¸å¦‚é€‰ä¸­ã€é«˜äº®ç­‰è®¸å¤šåŠŸèƒ½åœ¨viewer.htmlå†…ï¼Œæ— æ³•ç›´æ¥ä»Zoteroä¸­è°ƒç”¨ï¼Œç›¸å…³æºç åœ¨pdf-readerç›®å½•ã€‚æœ¬èŠ‚ä»…ä½œä»‹ç»Zotero.Readerã€‚

æºç ä½ç½®ï¼š[chrome/content/zotero/xpcom/reader.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/reader.js)

## åŸºæœ¬ä½¿ç”¨

é€šè¿‡Zotero.Reader.\_readersè®¿é—®å½“å‰çš„ReaderInstanceå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡æœ‰\_iframeWindowå±æ€§ï¼Œå¯å¯¹å…¶æ‰§è¡Œç•Œé¢æ“ä½œã€‚

```
Zotero.Reader.getByTabID(Zotero_Tabs.selectedID);
```

```
const cont = document.getElementById(`${Zotero_Tabs.selectedID}-context`);
const box = cont.querySelector("tabbox");
box.tabs.append(tab);
box.tabpanels.append(panel);
```

## è°ƒç”¨pdf.jsæ¥å£

ReaderInstanceå¯¹è±¡çš„_iframeWindowå±æ€§æ˜¯é˜…è¯»å™¨çš„windowå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åœ¨ç½‘é¡µç‰ˆæ‰€çœ‹åˆ°çš„å†…å®¹ï¼Œå®ƒåŒ…å«äº†æ•´ä¸ªpdfé˜…è¯»å™¨çš„documentå¯¹è±¡ä¸wrappedJSObjectå­—æ®µã€‚

é€šè¿‡è°ƒç”¨`._iframeWindow.wrappedJSObject`å¯åœ¨é˜…è¯»å™¨å‘½åç©ºé—´å¤–è®¿é—®å…¶å±€éƒ¨å˜é‡ï¼Œå…¶ä¸­çš„æ–¹æ³•æœ‰zoteroCopyImageå’ŒzoteroSaveImageAsç­‰ã€‚åŒæ—¶ä»–åŒ…å«äº†PDFViewerApplicationå¯¹è±¡ï¼Œè¯¥éƒ¨åˆ†æºç åœ¨

[é“¾æ¥](https://github.com/zotero/pdf-reader/tree/master/src)

```
._iframeWindow.wrappedJSObject.PDFViewerApplication.pdfViewer.currentPageNumber
```

æ­¤å¤–ï¼Œé€šè¿‡æ³¨å…¥è„šæœ¬çš„æ–¹å¼å¯ä»¥ç›´æ¥è®¿é—®PDFViewerApplicationå¯¹è±¡æ¥æ“ä½œé˜…è¯»å™¨ï¼š

https://gitee.com/const_volatile/chartero/blob/master/chrome/content/reader.js

### æ¡ˆä¾‹

#### 1\. è·å–pdfæŒ‡å®šé¡µé¢æ‰€æœ‰æ–‡å­—

ä»¥ç¬¬ä¸€é¡µä¸ºä¾‹ï¼Œç´¢å¼•ä¸º0ï¼š

```
const reader = Zotero.Reader.getByTabID(Zotero_Tabs).selectedID);
const PDFViewerApplication = reader._iframeWindow.wrappedJSObject.PDFViewerApplication;
await PDFViewerApplication.pdfLoadingTask.promise;
await PDFViewerApplication.pdfViewer.pagesPromise;
let pages = PDFViewerApplication.pdfViewer._pages;
let pdfPage = pages[0].pdfPage;
let items = (await pdfPage.getTextContent()).items; 
```

è¿™é‡Œä»¥item=items\[0\]ä¸ºä¾‹ï¼š

```
{
  chars: Array(63) [ {â€¦}, {â€¦}, {â€¦}, â€¦ ]
	dir: "ltr"
	fontName: "g_d0_f1"
	height: 6.376
	str: "Ma, Z., Hu, X., Huang, L., Bi, J., Liu, Y., 2014."
	transform: [6.376, 0, 0, 6.376, 42.5197, 732.5289]
	width: 202.367864
}
```

è¿™é‡Œçš„item.charsè®°å½•äº†item.strçš„æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„æ¸²æŸ“ä¿¡æ¯ã€‚é™¤äº†å®½é«˜å¤–ï¼Œitem.transformè¿˜æä¾›äº†(x=item.transform\[4\], y=item.transform\[5\])ä½ç½®ä¿¡æ¯ã€‚è¿™ä¸ªä½ç½®ä»¥pdfé¡µé¢å·¦ä¸‹è§’ä¸ºåŸç‚¹ã€‚

æ ¹æ®pdfé¡µé¢å†…çš„æ–‡å­—å¯ä»¥è§£æå‡ºæ‰€æœ‰å‚è€ƒæ–‡çŒ®ï¼Œè¯¦è§ï¼š

[zotero-reference](https://github.com/MuiseDestiny/zotero-reference)

# Zotero.Notes

Zotero.EditorInstanceç±»æ˜¯ç¬”è®°ç¼–è¾‘å™¨çš„æŠ½è±¡ï¼›Zotero.EditorInstanceUtilitieså¯¹è±¡åŒ…æ‹¬äº†ç¬”è®°ä¸­ä¸€äº›è½¬æ¢ç­‰åŸºç¡€åŠŸèƒ½ã€‚

æºç ä½ç½®ï¼š[chrome/content/zotero/xpcom/editorInstance.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/editorInstance.js)

Zotero.Notesæ˜¯æ‰€æœ‰EditorInstanceå®ä¾‹çš„ç®¡ç†å™¨ã€‚

æºç ä½ç½®ï¼š[chrome/content/zotero/xpcom/data/notes.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/xpcom/data/notes.js)

# Zotero_Tabs

Zotero 6ä»¥åçš„ç‰ˆæœ¬å¼•å…¥äº†æ ‡ç­¾é¡µï¼ˆtabï¼‰ã€‚å½“æ‰“å¼€PDFæ—¶ï¼Œé»˜è®¤åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ã€‚

æºç ä½ç½®ï¼š[chrome/content/zotero/tabs.js](https://github.com/zotero/zotero/blob/master/chrome/content/zotero/tabs.js)

## åŸºæœ¬ä½¿ç”¨

é€šè¿‡Zotero_Tabsè®¿é—®å½“å‰æ‰“å¼€çš„æ ‡ç­¾é¡µã€‚

### æ–°å¢æ ‡ç­¾é¡µ

é€šè¿‡Zotero_Tabs.addæ–¹æ³•æ–°å¢æ ‡ç­¾é¡µï¼Œä¾‹å¦‚Better Notesæ’ä»¶ä¸­çš„ä¸€æ®µä»£ç ï¼š

```
let { id, container } = Zotero_Tabs.add({
    type: "betternotes",
    title: Zotero.locale.includes("zh") ? "å·¥ä½œåŒº" : "Workspace",
    index: 1,
    data: {},
    select: select,
    onClose: undefined,
});
```

è¯·æ³¨æ„æ­¤å¤„çš„typeå°†å½±å“èœå•æ çš„æ˜¾ç¤º/éšè—ã€‚æˆªè‡³æ–‡æ¡£æ›´æ–°ï¼ˆ2022.08.22ï¼‰ï¼Œåœ¨ç¦»å¼€æ ‡ç­¾æ—¶ï¼Œè‡ªå®šä¹‰çš„æ ‡ç­¾ç±»å‹ä¸ä¼šè¢«æ­£ç¡®éšè—ï¼Œä½†åœ¨è¿›å…¥æ ‡ç­¾é¡µæ—¶ä¼šè¢«æ˜¾ç¤ºï¼ˆç›¸å…³ä»£ç åœ¨ZoteroStandalone.switchMenuTypeï¼‰ã€‚å› æ­¤éœ€è¦æ‰‹åŠ¨å¤„ç†ç¦»å¼€æ ‡ç­¾é¡µæ—¶éšè—è‡ªå®šä¹‰æ ‡ç­¾çš„éƒ¨åˆ†èœå•ã€‚

```
switchRealMenuBar(hidden: boolean) {
    // We only handle hide. The show will be handled by the ZoteroStandalone.switchMenuType
    document
      .querySelectorAll(".menu-type-betternotes")
      .forEach((el) => ((el as HTMLElement).hidden = hidden));

    // Disable Zotero pdf export
    (document.getElementById("menu_export_files") as XUL.Element).disabled =
      !hidden;
}
```

### æ ‡ç­¾é¡µæ“ä½œ

é€šè¿‡select/jump/move/closeç­‰ç›¸å…³æ–¹æ³•è¿›è¡Œæ“ä½œã€‚

```
Zotero_Tabs.select('zotero-pane');
```

# OS

éœ€è¦è°ƒç”¨ï¼š

```
 Components.utils.import("resource://gre/modules/osfile.jsm");
```

æ‰èƒ½ä½¿ç”¨ã€‚

## åŸºæœ¬ä½¿ç”¨

### æ–‡ä»¶é€‰æ‹©å™¨

ç”±zotfileè´¡çŒ®çš„å¼€æºfile_pickerå‡½æ•°ï¼Œç”±Better Noteså¢åŠ äº†TSç±»å‹æç¤ºï¼š

```
async function pick(title: string, mode: 'open' | 'save' | 'folder', filters?: [string, string][], suggestion?: string): Promise<string> {
    const fp = Components.classes['@mozilla.org/filepicker;1'].createInstance(Components.interfaces.nsIFilePicker)
  
    if (suggestion) fp.defaultString = suggestion
  
    mode = {
      open: Components.interfaces.nsIFilePicker.modeOpen,
      save: Components.interfaces.nsIFilePicker.modeSave,
      folder: Components.interfaces.nsIFilePicker.modeGetFolder,
    }[mode]
  
    fp.init(window, title, mode)
  
    for (const [label, ext] of (filters || [])) {
      fp.appendFilter(label, ext)
    }
  
    // eslint-disable-next-line @typescript-eslint/no-unsafe-return
    return new Zotero.Promise(resolve => {
      fp.open(userChoice => {
        switch (userChoice) {
          case Components.interfaces.nsIFilePicker.returnOK:
          case Components.interfaces.nsIFilePicker.returnReplace:
            resolve(fp.file.path)
            break
  
          default: // aka returnCancel
            resolve('')
            break
        }
      })
    })
  }
```

### æ–‡ä»¶è¯»å†™

å¯ä»¥ä½¿ç”¨ä¸Šè¿°OSå¯¹è±¡è¿›è¡Œæ–‡ä»¶è¯»å†™ã€‚

# Clipboard API

Zoteroä¸­å…³äºå‰ªåˆ‡æ¿çš„ç›¸å…³æ¥å£ã€‚ç”±äºZoteroç›®å‰åŸºäºFireFox60ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„å‰ªåˆ‡æ¿æ¥å£ã€‚

æ ·ä¾‹ä»£ç ä¸ºBetter Notesæ’ä»¶æä¾›çš„å‰ªåˆ‡æ¿åŒ…è£…ï¼š

```
class CopyHelper {
  transferable: any;
  clipboardService: any;

  constructor() {
    this.transferable = Components.classes[
      "@mozilla.org/widget/transferable;1"
    ].createInstance(Components.interfaces.nsITransferable);
    this.clipboardService = Components.classes[
      "@mozilla.org/widget/clipboard;1"
    ].getService(Components.interfaces.nsIClipboard);
  }

  public addText(source: string, type: "text/html" | "text/unicode") {
    const str = Components.classes[
      "@mozilla.org/supports-string;1"
    ].createInstance(Components.interfaces.nsISupportsString);
    str.data = source;
    this.transferable.addDataFlavor(type);
    this.transferable.setTransferData(type, str, source.length * 2);
    return this;
  }

  // Only Windows
  public addImage(source: string) {
    const io = Components.classes[
      "@mozilla.org/network/io-service;1"
    ].getService(Components.interfaces.nsIIOService);
    const channel = io.newChannel(source, null, null);
    const input = channel.open();
    const imgTools = Components.classes[
      "@mozilla.org/image/tools;1"
    ].getService(Components.interfaces.imgITools);

    const buffer = NetUtil.readInputStreamToString(input, input.available());
    const container = imgTools.decodeImageFromBuffer(
      buffer,
      buffer.length,
      channel.contentType
    );

    this.transferable.addDataFlavor(channel.contentType);
    this.transferable.setTransferData(channel.contentType, container, -1);
    return this;
  }

  public copy() {
    this.clipboardService.setData(
      this.transferable,
      null,
      Components.interfaces.nsIClipboard.kGlobalClipboard
    );
  }
}
```

ä½¿ç”¨æ ·ä¾‹ï¼š

```
new CopyHelper()
    .addText(html, "text/html")
    .addText(this._Addon.parse.parseHTMLToMD(html), "text/unicode")
    .copy();
```

# æœ¬åœ°åŒ–

```
Services.locale.getRequestedLocale()
Zotero.locale
```

æ­¤å¤„ä¸ºè¯­é›€å†…å®¹å¡ç‰‡ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼šhttps://zotero.yuque.com/staff-gkhviy/developer/sstdhz

[å»è¿™é‡Œè´¡çŒ®ä½ çš„ç¿»è¯‘ï¼](https://explore.transifex.com/zotero/zotero/)

https://github.com/zotero/zotero/blob/master/chrome/locale/zh-CN/zotero/zotero.properties

```
Zotero.getString('general.success')
```

# å¼¹å‡ºé€šçŸ¥

```
const popMsg = new Zotero.ProgressWindow({closeOnClick: false});
popMsg.changeHeadline('[Error]', '', 'Chartero');
popMsg.addDescription('----------');

let prog = new popMsg.ItemProgress('chrome://zotero/skin/cross.png', 'No!');
prog.setProgress(100);  // é»˜è®¤0æ˜¯ç°è‰²å›¾æ ‡ï¼Œ100æ˜¯æ­£å¸¸å›¾æ ‡ï¼Œå…¶ä»–æ˜¯è¿›åº¦æ¡
popMsg.addDescription('<a href="http://github.com">link</a>');

// æŒ‡å®šçˆ¶å…ƒç´ å®ç°ç¼©è¿›
let prog1 = new popMsg.ItemProgress('chrome://chartero/skin/bookmark.png', 'hello', prog);

popMsg.show()
popMsg.startCloseTimer(6666);  // æ¯«ç§’
```

<img src="https://cdn.nlark.com/yuque/0/2022/png/1818941/1663295573348-3c36a9d9-c62b-42a4-a5a5-1706c691e267.png" width="271.2" id="u437d84a1" class="ne-image">